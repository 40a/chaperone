

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Environment Variables &mdash; chaperone 0.2.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
    <link rel="top" title="chaperone 0.2.0 documentation" href="../index.html"/>
        <link rel="up" title="Chaperone Reference" href="index.html"/>
        <link rel="prev" title="Configuration: Logging Declarations" href="config-logging.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../index.html" class="icon icon-home"> chaperone
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../guide/chap-intro.html">Introduction to Chaperone</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../guide/chap-intro.html#overview">Overview</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../guide/chap-docker.html">Using Chaperone with Docker</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Chaperone Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="command-line.html">Chaperone Command Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="command-line.html#command-quick-reference">Command Quick Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="command-line.html#chaperone-command-execution">Chaperone Command Execution</a></li>
<li class="toctree-l3"><a class="reference internal" href="command-line.html#option-reference-information">Option Reference Information</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Chaperone Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="config-format.html">Configuration File Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="config-global.html">Configuration: Global Settings</a><ul>
<li class="toctree-l4"><a class="reference internal" href="config-global.html#settings-quick-reference">Settings Quick Reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="config-global.html#settings-reference">Settings Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="config-service.html">Configuration: Service Declarations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="config-service.html#service-quick-reference">Service Quick Reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="config-service.html#service-types">Service Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="config-service.html#service-config-reference">Service Config Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="config-logging.html">Configuration: Logging Declarations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="config-logging.html#logging-quick-reference">Logging Quick Reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="config-logging.html#syslog-selectors">Syslog Selectors</a></li>
<li class="toctree-l4"><a class="reference internal" href="config-logging.html#logging-config-reference">Logging Config Reference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Environment Variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview-and-quick-reference">Overview and Quick Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="#managing-environment-variables">Managing Environment Variables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#environment-inheritance">Environment Inheritance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#environment-variable-expansion">Environment Variable Expansion</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#variable-reference">Variable Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="#notify-socket">Notify Socket</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">chaperone</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Chaperone Reference</a> &raquo;</li>
      
    <li>Environment Variables</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="environment-variables">
<span id="ch-env"></span><h1>Environment Variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview-and-quick-reference">
<h2>Overview and Quick Reference<a class="headerlink" href="#overview-and-quick-reference" title="Permalink to this headline">¶</a></h2>
<p>Chaperone-specific environment variables are descirbed here.  Because environment variables
are an important configuration component for many applications, Chaperone tries to make
sure any Chaperone-specific variables do not automatically pollute the environment, and
yet are available when needed.</p>
<p>So, with few exceptions, Chaperone environment variables start with
the prefix <code class="docutils literal"><span class="pre">_CHAP_</span></code>, but are not automatically passed down to
services.  If you want to make these available to services, simply
define an environment variable in your configuration which expands to
one of the internal variables:</p>
<div class="highlight-python"><div class="highlight"><pre>settings: {
  env_set: {
    # Make the relevant service name available to all processes
    &#39;SERVICE_NAME&#39;: &#39;$(_CHAP_SERVICE)&#39;,
  }
}
</pre></div>
</div>
<table border="1" class="docutils" id="id1">
<span id="table-env-quick"></span><caption><span class="caption-number">Table 5 </span><span class="caption-text">Environment Variable Quick Reference</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="41%" />
<col width="59%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">environment variable</th>
<th class="head">meaning</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><a class="reference internal" href="#env-chap-config-dir"><span>_CHAP_CONFIG_DIR</span></a></td>
<td>Will be set to the full path to the directory containing the
configuration file or directory.</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#env-chap-interactive"><span>_CHAP_INTERACTIVE</span></a></td>
<td>Will be set to &#8220;1&#8221; if chaperone is running with a controlling tty.</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#env-chap-options"><span>_CHAP_OPTIONS</span></a></td>
<td>Recognized during start-up and contains any default command-line
options.</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#env-chap-service"><span>_CHAP_SERVICE</span></a></td>
<td>Contains the name of the current service.</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#env-chap-task-mode"><span>_CHAP_TASK_MODE</span></a></td>
<td>Will be set to &#8220;`&#8221; if chaperone was invoked with the
<a class="reference internal" href="command-line.html#option-task"><span>&#8211;task</span></a> option.</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#env-notify-socket"><span>NOTIFY_SOCKET</span></a></td>
<td>Set to the per-service systemd-compatible notify socket for
service started with <a class="reference internal" href="config-service.html#service-type"><span>type=notify</span></a>.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="managing-environment-variables">
<h2>Managing Environment Variables<a class="headerlink" href="#managing-environment-variables" title="Permalink to this headline">¶</a></h2>
<div class="section" id="environment-inheritance">
<h3>Environment Inheritance<a class="headerlink" href="#environment-inheritance" title="Permalink to this headline">¶</a></h3>
<p>Chaperone provides extensive control over environment variables as they are passed from the parent (often the
container technology, like Docker), and eventually down to individual services.</p>
<div class="figure align-center" id="id2">
<span id="figure-env"></span><img src="../_images/env_inherit.svg" /><p class="caption"><span class="caption-number">Fig. 1 </span><span class="caption-text">Chaperone Environment Management</span></p>
</div>
<p>As shown in <a class="reference internal" href="#figure-env"><span>Fig. 1</span></a>, Chaperone controls the environment at two levels, and with three separate directives:</p>
<ol class="arabic simple">
<li>Chaperone creates a &#8220;global&#8221; settings environment which consists of environment variables inherited from
the parent environment, modified by the three environment directives <a class="reference internal" href="config-global.html#settings-env-inherit"><span>env_inherit</span></a>,
<a class="reference internal" href="config-global.html#settings-env-set"><span>env_set</span></a>, and <a class="reference internal" href="config-global.html#settings-env-unset"><span>env_unset</span></a>.</li>
<li>Each service can further modify the resulting environment using the same directives, and the changes apply
only to the environment of the selected service.</li>
</ol>
<p>In each case, Chaperone processes each set of directives in the same way:</p>
<ol class="arabic simple">
<li>The new environment is initialized based upon the setting of <a class="reference internal" href="config-global.html#settings-env-inherit"><span>env_inherit</span></a>,
a list of patterns.  If not specified, Chaperone assumes all environment variables will be inherited.</li>
<li>Then, Chaperone sets any new environment variables specified by <a class="reference internal" href="config-global.html#settings-env-set"><span>env_set</span></a>.</li>
<li>Finally, any environment variables specified by <a class="reference internal" href="config-global.html#settings-env-unset"><span>env_unset</span></a> are removed
if they exist.</li>
</ol>
</div>
<div class="section" id="environment-variable-expansion">
<span id="env-expansion"></span><h3>Environment Variable Expansion<a class="headerlink" href="#environment-variable-expansion" title="Permalink to this headline">¶</a></h3>
<p>Environment variable directives (as well as some others), can contain environment variable expansions, as indicated below:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">$(ENVVAR)</span></code> or <code class="docutils literal"><span class="pre">${ENVVAR}</span></code></dt>
<dd>Expands to the specified environment variable.  If the environment variable is not defined, the expansion text
is not replace and will appear as is.</dd>
<dt><code class="docutils literal"><span class="pre">$(ENVVAR:-default)</span></code></dt>
<dd>Inserts the environment variable if it is present, otherwise, expands to the string specified by <code class="docutils literal"><span class="pre">default</span></code> (which can
be blank).</dd>
<dt><code class="docutils literal"><span class="pre">$(ENVVAR:+ifpresent)</span></code></dt>
<dd>Inserts <code class="docutils literal"><span class="pre">ifpresent</span></code> if the environment variable <em>is defined</em>, otherwise inserts the empty string.</dd>
</dl>
<p>The second two forms are borrowed from <code class="docutils literal"><span class="pre">bash</span></code> and can be useful in cases where defaults are required.  For example,
if you wanted to specify the user for a service in the event no user was otherwise specified:</p>
<div class="highlight-python"><div class="highlight"><pre>sample.service: {
  uid: &quot;$(USER:-www-data)&quot;
  ...
}
</pre></div>
</div>
<p>The above would expand to the value of <code class="docutils literal"><span class="pre">USER</span></code> if it exists, otherwise would expand to <code class="docutils literal"><span class="pre">www-data</span></code>.  Not all directives
support environment expansion.  When it is supported, it will be explicitly indicated in the reference documentation for
the directive (for example, the <a class="reference internal" href="config-service.html#service-directory"><span>service directory</span></a> directive).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Environment variables are expanded <em>as late as possible</em> so that declarations defined at the global level can, if desired,
be filled in automatically at lower levels.  For example, consider this globally set environment variable declaration:</p>
<div class="highlight-python"><div class="highlight"><pre>settings: {
  env_set: {
    &#39;MY_NAME&#39;: &#39;$(_CHAP_SERVICE)&#39;,
    &#39;HAS_NOTIFY_SOCKET&#39;: &#39;$(NOTIFY_SOCKET:+1)&#39;,
    &#39;PATH&#39;: &#39;/service-bins/$(MY_NAME):$(PATH)&#39;,
  }
}
</pre></div>
</div>
<p class="last">In the above case, note that all environment variables are dependent upon values which will <em>not exist</em>
until later when a service is executed.  Specifically <code class="docutils literal"><span class="pre">_CHAP_SERVICE</span></code> is set to the service name, and
<code class="docutils literal"><span class="pre">NOTIFY_SOCKET</span></code> will be set only if a socket is allocated when the process is run.  However, Chaperone
assures that such environment variables use late-expansion so that templates such as the above can
be created and inherited by both logging and service declarations.</p>
</div>
</div>
</div>
<div class="section" id="variable-reference">
<h2>Variable Reference<a class="headerlink" href="#variable-reference" title="Permalink to this headline">¶</a></h2>
<span class="target" id="env-chap-config-dir"></span><dl class="envvar">
<dt id="envvar-_CHAP_CONFIG_DIR">
<code class="descname">_CHAP_CONFIG_DIR</code><a class="headerlink" href="#envvar-_CHAP_CONFIG_DIR" title="Permalink to this definition">¶</a></dt>
<dd><p>This is the path to the directory which <em>contains</em> the target specified by
the <a class="reference internal" href="command-line.html#cmdoption-chaperone--config"><code class="xref std std-option docutils literal"><span class="pre">--config</span></code></a> option.</p>
<p>For example, if you start Chaperone with the following command:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">chaperone</span> <span class="o">--</span><span class="n">config</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">appsuser</span><span class="o">/</span><span class="n">firstapp</span><span class="o">/</span><span class="n">chaperone</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>then this environment variable will be set to <code class="docutils literal"><span class="pre">/home/appsuser/firstapp</span></code>.  Note that
the method is the same <em>even if a configuration directory is specified</em>.  Thus, this
command:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">chaperone</span> <span class="o">--</span><span class="n">config</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">appsuser</span><span class="o">/</span><span class="n">firstapp</span><span class="o">/</span><span class="n">chaperone</span><span class="o">.</span><span class="n">d</span>
</pre></div>
</div>
<p>would set <code class="docutils literal"><span class="pre">_CHAP_CONFIG_DIR</span></code> to exactly the same value even though the target
is a directory rather than a file.</p>
<p>One very useful application of this variable is to define &#8220;self-relative&#8221; execution
environments where all application files are stored relative to the location of the
configuration directory.  The <code class="docutils literal"><span class="pre">chaperone-baseimage</span></code> does this with the following
declaration:</p>
<div class="highlight-python"><div class="highlight"><pre>settings: {
  env_set: {
    &#39;APPS_DIR&#39;: &#39;$(_CHAP_CONFIG_DIR:-/)&#39;,
  }
}
</pre></div>
</div>
<p>Then, all other files, commands and configurations operate relative to the <code class="docutils literal"><span class="pre">APPS_DIR</span></code>
environment variable.   If this principle is observed carefully you can easily run:</p>
<div class="highlight-python"><div class="highlight"><pre>docker run --config /myapps/prerelease/chaperone.d
</pre></div>
</div>
<p>to run an isolated set of applications stored in <code class="docutils literal"><span class="pre">/myapps/prerelease</span></code> and another
set of isolated applications in the same image like this:</p>
<div class="highlight-python"><div class="highlight"><pre>docker run --config /myapps/stable/chaperone.d
</pre></div>
</div>
</dd></dl>

<span class="target" id="env-chap-options"></span><dl class="envvar">
<dt id="envvar-_CHAP_OPTIONS">
<code class="descname">_CHAP_OPTIONS</code><a class="headerlink" href="#envvar-_CHAP_OPTIONS" title="Permalink to this definition">¶</a></dt>
<dd><p>When Chaperone starts, it reads options both from the command line and from this environment
variable.  The environment variable provides defaults which should be used if they are
not present on the command line.</p>
<p>For example, in the <code class="docutils literal"><span class="pre">chaperone-baseimage</span></code> image configuration, the default value
for <code class="docutils literal"><span class="pre">--config</span></code> is set:</p>
<div class="highlight-python"><div class="highlight"><pre>ENV _CHAP_OPTIONS --config apps/chaperone.d
ENTRYPOINT [&quot;/usr/local/bin/chaperone&quot;]
</pre></div>
</div>
</dd></dl>

<span class="target" id="env-chap-interactive"></span><dl class="envvar">
<dt id="envvar-_CHAP_INTERACTIVE">
<code class="descname">_CHAP_INTERACTIVE</code><a class="headerlink" href="#envvar-_CHAP_INTERACTIVE" title="Permalink to this definition">¶</a></dt>
<dd><p>This variable will always be set by Chaperone to either &#8220;0&#8221; or &#8220;1&#8221;.  A &#8220;1&#8221; value
indicates that Chaperone detected a controlling terminal (pseudo-tty).  For example:</p>
<div class="highlight-python"><div class="highlight"><pre>$ docker run -t -i chapdev/chaperone-baseimage --task /bin/echo &#39;$(_CHAP_INTERACTIVE)&#39;
1
$ docker run -i chapdev/chaperone-baseimage --task /bin/echo &#39;$(_CHAP_INTERACTIVE)&#39;
0
$
</pre></div>
</div>
<p>Exporting this value to services can allow services to detect interactive
vs. daemon containers in order to tailor their operation.</p>
</dd></dl>

<span class="target" id="env-chap-service"></span><dl class="envvar">
<dt id="envvar-_CHAP_SERVICE">
<code class="descname">_CHAP_SERVICE</code><a class="headerlink" href="#envvar-_CHAP_SERVICE" title="Permalink to this definition">¶</a></dt>
<dd><p>For each <a class="reference internal" href="config-service.html#service"><span>service definition</span></a>, this variable will be set to the name
of the service itself, including the <code class="docutils literal"><span class="pre">.service</span></code> suffix.  So, the service:</p>
<div class="highlight-python"><div class="highlight"><pre>mydata.service: {
  command: &quot;/bin/bash -c &#39;/bin/echo $(_CHAP_SERVICE) &gt;/tmp/service.txt&#39;&quot;
}
</pre></div>
</div>
<p>will write <code class="docutils literal"><span class="pre">mydata.service</span></code> to the file <code class="docutils literal"><span class="pre">/tmp/service.txt</span></code> (not particularly useful).</p>
<p>Note that even the main command runs as a conventional service named &#8220;CONSOLE&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre>$ docker run -i chapdev/chaperone-baseimage --task /bin/echo &#39;$(_CHAP_SERVICE)&#39;
CONSOLE
$
</pre></div>
</div>
</dd></dl>

<span class="target" id="env-chap-task-mode"></span><dl class="envvar">
<dt id="envvar-_CHAP_TASK_MODE">
<code class="descname">_CHAP_TASK_MODE</code><a class="headerlink" href="#envvar-_CHAP_TASK_MODE" title="Permalink to this definition">¶</a></dt>
<dd><p>This variable will be defined and set to &#8220;1&#8221; whenever Chaperone was run with the
<a class="reference internal" href="command-line.html#option-task"><span>&#8211;task</span></a> command-line option.</p>
<p>It can be used within scripts or applications to tailor behavior, if desired.</p>
</dd></dl>

</div>
<div class="section" id="notify-socket">
<h2>Notify Socket<a class="headerlink" href="#notify-socket" title="Permalink to this headline">¶</a></h2>
<span class="target" id="env-notify-socket"></span><dl class="envvar">
<dt id="envvar-NOTIFY_SOCKET">
<code class="descname">NOTIFY_SOCKET</code><a class="headerlink" href="#envvar-NOTIFY_SOCKET" title="Permalink to this definition">¶</a></dt>
<dd><p>Chaperone attempts to emulate <code class="docutils literal"><span class="pre">systemd</span></code> behavior by providing a
<a class="reference internal" href="config-service.html#service-sect-type"><span>&#8220;forking&#8221; service type</span></a>.   Processes created by this type
will have the additional variable <code class="docutils literal"><span class="pre">NOTIFY_SOCKET</span></code> set in their environment,
which is the path to a UNIX domain socket created privately within the
container.  The service should use this environment variable to trigger
notifications compatible with</p>
</dd></dl>

</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="config-logging.html" class="btn btn-neutral" title="Configuration: Logging Declarations" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Gary J. Wisniewski.
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>